<div class="card">
  <h2>Context Graph</h2>
  <%= form_with url: traces_path, method: :get, local: true do |f| %>
    <div class="filters-grid">
      <div>
        <%= f.label :q, "Search" %>
        <%= f.text_field :q, value: @query, placeholder: "Trace, source, record type/id" %>
      </div>
      <div>
        <%= f.label :status, "Status" %>
        <%= f.select :status, options_for_select([["All", ""], ["Error", "error"], ["OK", "ok"]], @status) %>
      </div>
      <div>
        <%= f.label :trace_type, "Type" %>
        <%= f.select :trace_type, options_for_select([["All", ""]] + @trace_type_options.map { |type| [type.to_s.titleize, type] }, @trace_type) %>
      </div>
      <div>
        <%= f.label :source, "Source contains" %>
        <%= f.text_field :source, value: @source, placeholder: "Controller, Job..." %>
      </div>
      <div>
        <%= f.label :context_key, "Context key" %>
        <%= f.text_field :context_key, value: @context_key, placeholder: "e.g. project_id" %>
      </div>
      <div>
        <%= f.label :context_id, "Context value" %>
        <%= f.text_field :context_id, value: @context_id, placeholder: "e.g. 123" %>
      </div>
      <div>
        <%= f.label :entity_type, "Entity type" %>
        <%= f.text_field :entity_type, value: @entity_type, placeholder: "e.g. Order" %>
      </div>
      <div>
        <%= f.label :entity_id, "Entity id" %>
        <%= f.text_field :entity_id, value: @entity_id, placeholder: "e.g. 123" %>
      </div>
      <div>
        <%= f.label :error_fingerprint, "Error fingerprint" %>
        <%= f.text_field :error_fingerprint, value: @error_fingerprint, placeholder: "sha256..." %>
      </div>
      <div>
        <%= f.label :request_id, "Request id" %>
        <%= f.text_field :request_id, value: @request_id, placeholder: "uuid..." %>
      </div>
      <div>
        <%= f.label :feature_key, "Feature key" %>
        <%= f.select :feature_key, options_for_select([["Any", ""]] + SolidEvents.feature_slice_keys.map { |key| [key, key] }, @feature_key) %>
      </div>
      <div>
        <%= f.label :feature_value, "Feature value" %>
        <%= f.text_field :feature_value, value: @feature_value, placeholder: "e.g. premium_checkout" %>
      </div>
      <div>
        <%= f.label :window, "Time window" %>
        <%= f.select :window, options_for_select([["1 hour", "1h"], ["24 hours", "24h"], ["7 days", "7d"], ["All", "all"]], @window) %>
      </div>
      <div>
        <%= f.label :min_duration_ms, "Min duration (ms)" %>
        <%= f.text_field :min_duration_ms, value: @min_duration_ms, placeholder: "e.g. 250" %>
      </div>
      <div>
        <%= f.label :per_page, "Rows per page" %>
        <%= f.select :per_page, options_for_select([25, 50, 100], @per_page) %>
      </div>
    </div>
    <div class="actions">
      <%= f.submit "Apply Filters" %>
      <%= link_to "Reset", traces_path, class: "button button-muted" %>
    </div>
  <% end %>
</div>

<div class="stats-grid">
  <div class="card stat">
    <span class="label">Showing</span>
    <strong><%= @traces.size %></strong>
  </div>
  <div class="card stat">
    <span class="label">Filtered Total</span>
    <strong><%= @total_count %></strong>
  </div>
  <div class="card stat">
    <span class="label">Errors</span>
    <strong><%= @error_count %></strong>
  </div>
  <div class="card stat">
    <span class="label">Page</span>
    <strong><%= @page %>/<%= [@page_count, 1].max %></strong>
  </div>
</div>

<div class="stats-grid">
  <div class="card stat">
    <span class="label">Throughput</span>
    <strong><%= @slo_panel[:throughput] %></strong>
  </div>
  <div class="card stat">
    <span class="label">Error Rate</span>
    <strong><%= @slo_panel[:error_rate_pct] %>%</strong>
  </div>
  <div class="card stat">
    <span class="label">P95</span>
    <strong><%= @slo_panel[:p95_ms] || "n/a" %> ms</strong>
  </div>
  <div class="card stat">
    <span class="label">P99</span>
    <strong><%= @slo_panel[:p99_ms] || "n/a" %> ms</strong>
  </div>
</div>

<div class="card">
  <h3>Compare Metrics</h3>
  <%= form_with url: traces_path, method: :get, local: true do |f| %>
    <% request.query_parameters.each do |key, value| %>
      <% next if key.in?(%w[compare_dimension compare_metric compare_window compare_baseline_window page]) %>
      <%= hidden_field_tag key, value %>
    <% end %>
    <div class="filters-grid">
      <div>
        <%= f.label :compare_metric, "Metric" %>
        <%= f.select :compare_metric, options_for_select([["Error Rate %", "error_rate"], ["Avg Latency (ms)", "latency_avg"]], @compare_metric) %>
      </div>
      <div>
        <%= f.label :compare_dimension, "Group by" %>
        <%= f.select :compare_dimension, options_for_select([["Source", "source"], ["Name", "name"], ["Deployment", "deployment_id"], ["Version", "service_version"], ["Environment", "environment_name"], ["Entity Type", "entity_type"]], @compare_dimension) %>
      </div>
      <div>
        <%= f.label :compare_window, "Current window" %>
        <%= f.select :compare_window, options_for_select([["1 hour", "1h"], ["24 hours", "24h"], ["7 days", "7d"], ["30 days", "30d"]], @compare_window) %>
      </div>
      <div>
        <%= f.label :compare_baseline_window, "Baseline window" %>
        <%= f.select :compare_baseline_window, options_for_select([["1 hour", "1h"], ["24 hours", "24h"], ["7 days", "7d"], ["30 days", "30d"]], @compare_baseline_window) %>
      </div>
    </div>
    <div class="actions">
      <%= f.submit "Compare" %>
    </div>
  <% end %>
  <div class="table-scroll">
    <table class="events-table">
      <thead>
        <tr>
          <th>Value</th>
          <th>Current</th>
          <th>Baseline</th>
          <th>Delta</th>
          <th>Delta %</th>
          <th>Current Samples</th>
          <th>Baseline Samples</th>
        </tr>
      </thead>
      <tbody>
        <% @compare_rows.each do |row| %>
          <tr>
            <td><%= row[:key].presence || "n/a" %></td>
            <td><%= row[:current] %></td>
            <td><%= row[:baseline] %></td>
            <td><%= row[:delta] %></td>
            <td><%= row[:delta_pct].nil? ? "n/a" : "#{row[:delta_pct]}%" %></td>
            <td><%= row[:current_count] %></td>
            <td><%= row[:baseline_count] %></td>
          </tr>
        <% end %>
        <% if @compare_rows.empty? %>
          <tr><td colspan="7" class="muted">No data for compare view yet.</td></tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<div class="card">
  <h3>Saved Views</h3>
  <% if @active_shared_view_label.present? %>
    <p class="muted">Shared view: <strong><%= @active_shared_view_label %></strong></p>
  <% end %>
  <%= form_with url: saved_views_path, method: :post, local: true do |f| %>
    <div class="filters-grid">
      <div>
        <%= f.label :name, "Name" %>
        <%= f.text_field :name, placeholder: "e.g. Checkout regressions", required: true %>
      </div>
      <div>
        <%= f.label :created_by, "Created by" %>
        <%= f.text_field :created_by, placeholder: "optional" %>
      </div>
    </div>
    <% request.query_parameters.each do |key, value| %>
      <%= hidden_field_tag "filters[#{key}]", value %>
    <% end %>
    <div class="actions">
      <%= f.submit "Save Current Filters" %>
    </div>
  <% end %>
  <div class="table-scroll">
    <table class="events-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Created By</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @saved_views.each do |saved_view| %>
          <tr>
            <td><%= saved_view.name %></td>
            <td><%= saved_view.created_by.presence || "n/a" %></td>
            <td title="<%= absolute_time(saved_view.created_at) %>"><%= relative_time(saved_view.created_at) %></td>
            <td>
              <%= link_to "Apply", traces_path(saved_view_id: saved_view.id), class: "button button-muted" %>
              <%= link_to "Share", @saved_view_share_links[saved_view.id], class: "button button-muted" %>
              <%= button_to "Delete", saved_view_path(saved_view), method: :delete, class: "button button-muted" %>
            </td>
          </tr>
        <% end %>
        <% if @saved_views.empty? %>
          <tr><td colspan="4" class="muted">No saved views yet.</td></tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<div class="card">
  <h3>Journey Sequences</h3>
  <%= form_with url: traces_path, method: :get, local: true do |f| %>
    <% request.query_parameters.each do |key, value| %>
      <% next if key.in?(%w[journey_group_by journey_limit journey_errors_only page]) %>
      <%= hidden_field_tag key, value %>
    <% end %>
    <div class="filters-grid">
      <div>
        <%= f.label :journey_group_by, "Group by" %>
        <%= f.select :journey_group_by, options_for_select([["Request id", "request"], ["Entity", "entity"]], @journey_group_by) %>
      </div>
      <div>
        <%= f.label :journey_limit, "Rows" %>
        <%= f.select :journey_limit, options_for_select([5, 10, 20], @journey_limit) %>
      </div>
      <div>
        <%= f.label :journey_errors_only, "Only failing journeys" %>
        <%= f.select :journey_errors_only, options_for_select([["No", false], ["Yes", true]], @journey_errors_only) %>
      </div>
    </div>
    <div class="actions">
      <%= f.submit "Refresh Journeys" %>
    </div>
  <% end %>
  <div class="table-scroll">
    <table class="events-table">
      <thead>
        <tr>
          <th>Journey</th>
          <th>Traces</th>
          <th>Errors</th>
          <th>Started</th>
          <th>Finished</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @journey_rows.each do |journey| %>
          <tr>
            <td><%= journey[:journey_key] %></td>
            <td><%= journey[:trace_count] %></td>
            <td><%= journey[:error_count] %></td>
            <td title="<%= absolute_time(journey[:started_at]) %>"><%= relative_time(journey[:started_at]) %></td>
            <td title="<%= absolute_time(journey[:finished_at]) %>"><%= relative_time(journey[:finished_at]) %></td>
            <td>
              <% if journey[:request_id].present? %>
                <%= link_to "API", "/solid_events/api/journeys?request_id=#{CGI.escape(journey[:request_id])}&window=#{@window}&errors_only=#{@journey_errors_only}", class: "button button-muted" %>
                <%= link_to "Traces", traces_path(request_id: journey[:request_id]), class: "button button-muted" %>
                <%= link_to "Timeline", "/solid_events/timeline?request_id=#{CGI.escape(journey[:request_id])}&window=#{@window}", class: "button button-muted" %>
              <% elsif journey[:entity_type].present? && journey[:entity_id].present? %>
                <%= link_to "API", "/solid_events/api/journeys?entity_type=#{CGI.escape(journey[:entity_type])}&entity_id=#{journey[:entity_id]}&window=#{@window}&errors_only=#{@journey_errors_only}", class: "button button-muted" %>
                <%= link_to "Traces", traces_path(entity_type: journey[:entity_type], entity_id: journey[:entity_id]), class: "button button-muted" %>
                <%= link_to "Timeline", "/solid_events/timeline?entity_type=#{CGI.escape(journey[:entity_type])}&entity_id=#{journey[:entity_id]}&window=#{@window}", class: "button button-muted" %>
              <% end %>
            </td>
          </tr>
        <% end %>
        <% if @journey_rows.empty? %>
          <tr><td colspan="6" class="muted">No journeys in this window.</td></tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<div class="card">
  <h3>Incidents Feed</h3>
  <div class="table-scroll">
    <table class="events-table">
      <thead>
        <tr>
          <th>Detected</th>
          <th>Status</th>
          <th>Severity</th>
          <th>Kind</th>
          <th>Name</th>
          <th>Owner</th>
          <th>Team</th>
          <th>Source</th>
          <th>Last Seen</th>
          <th>Details</th>
          <th>Lifecycle</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @incidents.each do |incident| %>
          <tr>
            <td title="<%= absolute_time(incident.detected_at) %>"><%= relative_time(incident.detected_at) %></td>
            <td><span class="badge <%= incident.status == "active" ? "error" : "muted" %>"><%= incident.status %></span></td>
            <td><span class="badge <%= incident.severity == "critical" ? "error" : "muted" %>"><%= incident.severity %></span></td>
            <td><%= incident.kind %></td>
            <td><%= incident.name %></td>
            <td><%= incident.owner || "unassigned" %></td>
            <td><%= incident.team || "n/a" %></td>
            <td><%= incident.source %></td>
            <td title="<%= absolute_time(incident.last_seen_at) %>"><%= relative_time(incident.last_seen_at) %></td>
            <td><%= incident.payload.to_h.to_json %></td>
            <td>
              <% rows = @incident_event_rows[incident.id] || [] %>
              <% if rows.any? %>
                <% rows.each do |event| %>
                  <div class="muted"><%= event.action %> (<%= relative_time(event.occurred_at) %>)</div>
                <% end %>
              <% else %>
                <span class="muted">no events</span>
              <% end %>
              <div><%= link_to "API", "/solid_events/api/incidents/#{incident.id}/events", class: "button button-muted" %></div>
            </td>
            <td>
              <% trace_query = incident.payload.to_h["trace_query"].to_h.symbolize_keys %>
              <% if trace_query.present? %>
                <%= link_to "Open traces", traces_path(trace_query), class: "button button-muted" %>
                <% compare_params = {
                  compare_dimension: "deployment_id",
                  compare_metric: "error_rate",
                  compare_window: "24h",
                  compare_baseline_window: "7d"
                }.merge(trace_query.slice("name", "source")) %>
                <%= link_to "Compare deploy", traces_path(compare_params), class: "button button-muted" %>
              <% end %>
              <% journey_link = @incident_journey_links[incident.id] %>
              <% if journey_link.present? %>
                <%= link_to "Open journey", journey_link[:ui_path], class: "button button-muted" %>
                <%= link_to "Journey API", journey_link[:api_path], class: "button button-muted" %>
              <% end %>
              <% if incident.status == "active" %>
                <%= button_to "Ack", acknowledge_incident_path(incident), method: :patch, class: "button button-muted" %>
                <%= button_to "Resolve", resolve_incident_path(incident), method: :patch, class: "button button-muted" %>
              <% elsif incident.status == "acknowledged" %>
                <%= button_to "Resolve", resolve_incident_path(incident), method: :patch, class: "button button-muted" %>
                <%= button_to "Reopen", reopen_incident_path(incident), method: :patch, class: "button button-muted" %>
              <% else %>
                <%= button_to "Reopen", reopen_incident_path(incident), method: :patch, class: "button button-muted" %>
              <% end %>
            </td>
          </tr>
        <% end %>
        <% if @incidents.empty? %>
          <tr><td colspan="12" class="muted">No incidents detected.</td></tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<div class="card">
  <h3>Hot Paths (7d)</h3>
  <div class="table-scroll">
    <table class="events-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Source</th>
          <th>Count</th>
          <th>P50</th>
          <th>P95</th>
          <th>P99</th>
          <th>Error Rate</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @hot_paths.each do |path| %>
          <tr>
            <td><%= link_to path[:name], path[:link] %></td>
            <td><%= link_to path[:source], path[:link] %></td>
            <td><%= path[:count] %></td>
            <td><%= path[:p50_ms] %> ms</td>
            <td><%= path[:p95_ms] %> ms</td>
            <td><%= path[:p99_ms] %> ms</td>
            <td><%= path[:error_rate_pct] %>%</td>
            <td>
              <%= link_to "Compare deploy", traces_path(compare_dimension: "deployment_id", compare_metric: "latency_avg", compare_window: "24h", compare_baseline_window: "7d", source: path[:source]), class: "button button-muted" %>
            </td>
          </tr>
        <% end %>
        <% if @hot_paths.empty? %>
          <tr><td colspan="8" class="muted">Not enough traces to compute hot paths yet.</td></tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<div class="card">
  <h3>Regression Candidates (24h vs prior 7d)</h3>
  <div class="table-scroll">
    <table class="events-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Source</th>
          <th>Recent Avg</th>
          <th>Baseline Avg</th>
          <th>Delta</th>
        </tr>
      </thead>
      <tbody>
        <% @regression_candidates.each do |candidate| %>
          <tr>
            <td><%= candidate[:name] %></td>
            <td><%= candidate[:source] %></td>
            <td><%= candidate[:recent_avg_duration_ms] %> ms</td>
            <td><%= candidate[:baseline_avg_duration_ms] %> ms</td>
            <td><%= candidate[:delta_ms] %> ms</td>
          </tr>
        <% end %>
        <% if @regression_candidates.empty? %>
          <tr><td colspan="5" class="muted">No active regressions detected.</td></tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<div class="card">
  <h3>New Error Fingerprints (24h)</h3>
  <ul>
    <% @new_error_fingerprints.each do |entry| %>
      <li>
        <code><%= entry[:fingerprint] %></code>
        in <strong><%= entry[:source] %></strong>
        (<%= link_to "trace ##{entry[:trace_id]}", trace_path(entry[:trace_id]) %>)
      </li>
    <% end %>
    <% if @new_error_fingerprints.empty? %>
      <li class="muted">No new fingerprints in the last 24 hours.</li>
    <% end %>
  </ul>
</div>

<div class="card">
  <h3>New Error Fingerprints Since Current Deploy/Version</h3>
  <ul>
    <% @new_error_fingerprints_since_deploy.each do |entry| %>
      <li>
        <code><%= entry[:fingerprint] %></code>
        in <strong><%= entry[:source] %></strong>
        (<%= link_to "trace ##{entry[:trace_id]}", trace_path(entry[:trace_id]) %>)
      </li>
    <% end %>
    <% if @new_error_fingerprints_since_deploy.empty? %>
      <li class="muted">No fingerprints unique to current deploy/version.</li>
    <% end %>
  </ul>
</div>

<div class="card">
  <div class="table-scroll">
    <table class="traces-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Type</th>
        <th>Status</th>
        <th>Source</th>
        <th>Duration</th>
        <th>Events</th>
        <th>SQL Count</th>
        <th>SQL Time</th>
        <th>Records</th>
        <th>Errors</th>
        <th>Started</th>
      </tr>
    </thead>
    <tbody>
      <% @traces.each do |trace| %>
        <tr>
          <td><%= link_to trace.id, trace_path(trace) %></td>
          <td><%= trace.name %></td>
          <td><%= trace.trace_type %></td>
          <td><span class="badge <%= trace_status_badge(trace.status) %>"><%= trace.status %></span></td>
          <td><%= trace.source %></td>
          <td><%= formatted_trace_duration(trace) %></td>
          <td><%= trace_event_count(trace) %></td>
          <td><%= trace_sql_count(trace) %></td>
          <td><%= trace_sql_duration_ms(trace) %> ms</td>
          <td><%= trace_record_link_count(trace) %></td>
          <td><%= trace_error_link_count(trace) %></td>
          <td title="<%= absolute_time(trace.started_at) %>"><%= relative_time(trace.started_at) %></td>
        </tr>
      <% end %>
      <% if @traces.empty? %>
        <tr>
          <td colspan="12" class="muted">No traces found for the current filters.</td>
        </tr>
      <% end %>
    </tbody>
    </table>
  </div>
</div>

<div class="pagination">
  <% if @page > 1 %>
    <%= link_to "Previous", traces_path(request.query_parameters.merge(page: @page - 1)), class: "button button-muted" %>
  <% else %>
    <span></span>
  <% end %>
  <% if @page < @page_count %>
    <%= link_to "Next", traces_path(request.query_parameters.merge(page: @page + 1)), class: "button button-muted" %>
  <% end %>
</div>
