<div class="card">
  <h2>Context Graph</h2>
  <%= form_with url: traces_path, method: :get, local: true do |f| %>
    <div class="filters-grid">
      <div>
        <%= f.label :q, "Search" %>
        <%= f.text_field :q, value: @query, placeholder: "Trace, source, record type/id" %>
      </div>
      <div>
        <%= f.label :status, "Status" %>
        <%= f.select :status, options_for_select([["All", ""], ["Error", "error"], ["OK", "ok"]], @status) %>
      </div>
      <div>
        <%= f.label :trace_type, "Type" %>
        <%= f.select :trace_type, options_for_select([["All", ""]] + @trace_type_options.map { |type| [type.to_s.titleize, type] }, @trace_type) %>
      </div>
      <div>
        <%= f.label :source, "Source contains" %>
        <%= f.text_field :source, value: @source, placeholder: "Controller, Job..." %>
      </div>
      <div>
        <%= f.label :context_key, "Context key" %>
        <%= f.text_field :context_key, value: @context_key, placeholder: "e.g. project_id" %>
      </div>
      <div>
        <%= f.label :context_id, "Context value" %>
        <%= f.text_field :context_id, value: @context_id, placeholder: "e.g. 123" %>
      </div>
      <div>
        <%= f.label :entity_type, "Entity type" %>
        <%= f.text_field :entity_type, value: @entity_type, placeholder: "e.g. Order" %>
      </div>
      <div>
        <%= f.label :entity_id, "Entity id" %>
        <%= f.text_field :entity_id, value: @entity_id, placeholder: "e.g. 123" %>
      </div>
      <div>
        <%= f.label :error_fingerprint, "Error fingerprint" %>
        <%= f.text_field :error_fingerprint, value: @error_fingerprint, placeholder: "sha256..." %>
      </div>
      <div>
        <%= f.label :request_id, "Request id" %>
        <%= f.text_field :request_id, value: @request_id, placeholder: "uuid..." %>
      </div>
      <div>
        <%= f.label :window, "Time window" %>
        <%= f.select :window, options_for_select([["1 hour", "1h"], ["24 hours", "24h"], ["7 days", "7d"], ["All", "all"]], @window) %>
      </div>
      <div>
        <%= f.label :min_duration_ms, "Min duration (ms)" %>
        <%= f.text_field :min_duration_ms, value: @min_duration_ms, placeholder: "e.g. 250" %>
      </div>
      <div>
        <%= f.label :per_page, "Rows per page" %>
        <%= f.select :per_page, options_for_select([25, 50, 100], @per_page) %>
      </div>
    </div>
    <div class="actions">
      <%= f.submit "Apply Filters" %>
      <%= link_to "Reset", traces_path, class: "button button-muted" %>
    </div>
  <% end %>
</div>

<div class="stats-grid">
  <div class="card stat">
    <span class="label">Showing</span>
    <strong><%= @traces.size %></strong>
  </div>
  <div class="card stat">
    <span class="label">Filtered Total</span>
    <strong><%= @total_count %></strong>
  </div>
  <div class="card stat">
    <span class="label">Errors</span>
    <strong><%= @error_count %></strong>
  </div>
  <div class="card stat">
    <span class="label">Page</span>
    <strong><%= @page %>/<%= [@page_count, 1].max %></strong>
  </div>
</div>

<div class="card">
  <h3>Regression Candidates (24h vs prior 7d)</h3>
  <div class="table-scroll">
    <table class="events-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Source</th>
          <th>Recent Avg</th>
          <th>Baseline Avg</th>
          <th>Delta</th>
        </tr>
      </thead>
      <tbody>
        <% @regression_candidates.each do |candidate| %>
          <tr>
            <td><%= candidate[:name] %></td>
            <td><%= candidate[:source] %></td>
            <td><%= candidate[:recent_avg_duration_ms] %> ms</td>
            <td><%= candidate[:baseline_avg_duration_ms] %> ms</td>
            <td><%= candidate[:delta_ms] %> ms</td>
          </tr>
        <% end %>
        <% if @regression_candidates.empty? %>
          <tr><td colspan="5" class="muted">No active regressions detected.</td></tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<div class="card">
  <h3>New Error Fingerprints (24h)</h3>
  <ul>
    <% @new_error_fingerprints.each do |entry| %>
      <li>
        <code><%= entry[:fingerprint] %></code>
        in <strong><%= entry[:source] %></strong>
        (<%= link_to "trace ##{entry[:trace_id]}", trace_path(entry[:trace_id]) %>)
      </li>
    <% end %>
    <% if @new_error_fingerprints.empty? %>
      <li class="muted">No new fingerprints in the last 24 hours.</li>
    <% end %>
  </ul>
</div>

<div class="card">
  <div class="table-scroll">
    <table class="traces-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Type</th>
        <th>Status</th>
        <th>Source</th>
        <th>Duration</th>
        <th>Events</th>
        <th>SQL Count</th>
        <th>SQL Time</th>
        <th>Records</th>
        <th>Errors</th>
        <th>Started</th>
      </tr>
    </thead>
    <tbody>
      <% @traces.each do |trace| %>
        <tr>
          <td><%= link_to trace.id, trace_path(trace) %></td>
          <td><%= trace.name %></td>
          <td><%= trace.trace_type %></td>
          <td><span class="badge <%= trace_status_badge(trace.status) %>"><%= trace.status %></span></td>
          <td><%= trace.source %></td>
          <td><%= formatted_trace_duration(trace) %></td>
          <td><%= trace_event_count(trace) %></td>
          <td><%= trace_sql_count(trace) %></td>
          <td><%= trace_sql_duration_ms(trace) %> ms</td>
          <td><%= trace_record_link_count(trace) %></td>
          <td><%= trace_error_link_count(trace) %></td>
          <td title="<%= absolute_time(trace.started_at) %>"><%= relative_time(trace.started_at) %></td>
        </tr>
      <% end %>
      <% if @traces.empty? %>
        <tr>
          <td colspan="12" class="muted">No traces found for the current filters.</td>
        </tr>
      <% end %>
    </tbody>
    </table>
  </div>
</div>

<div class="pagination">
  <% if @page > 1 %>
    <%= link_to "Previous", traces_path(request.query_parameters.merge(page: @page - 1)), class: "button button-muted" %>
  <% else %>
    <span></span>
  <% end %>
  <% if @page < @page_count %>
    <%= link_to "Next", traces_path(request.query_parameters.merge(page: @page + 1)), class: "button button-muted" %>
  <% end %>
</div>
