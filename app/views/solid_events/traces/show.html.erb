<div class="card">
  <div class="trace-header">
    <h2>Trace #<%= @trace.id %> - <%= @trace.name %></h2>
    <%= link_to "Back to Traces", traces_path, class: "button button-muted" %>
  </div>
  <p>
    Type: <strong><%= @trace.trace_type %></strong> |
    Source: <strong><%= @trace.source %></strong> |
    Status: <span class="badge <%= trace_status_badge(@trace.status) %>"><%= @trace.status %></span> |
    Duration: <strong><%= formatted_trace_duration(@trace) %></strong>
  </p>
  <p class="muted">
    Started: <%= absolute_time(@trace.started_at) %> |
    Finished: <%= absolute_time(@trace.finished_at) %>
  </p>
</div>

<div class="stats-grid">
  <div class="card stat"><span class="label">Events</span><strong><%= @events.size %></strong></div>
  <div class="card stat"><span class="label">Record Links</span><strong><%= @record_links.size %></strong></div>
  <div class="card stat"><span class="label">Error Links</span><strong><%= @error_links.size %></strong></div>
  <div class="card stat"><span class="label">Event Types</span><strong><%= @event_counts.keys.sort.join(", ").presence || "none" %></strong></div>
</div>

<div class="card">
  <h3>Canonical Event</h3>
  <pre><%= JSON.pretty_generate(@trace.canonical_event) %></pre>
</div>

<% if @trace.summary %>
  <div class="card">
    <h3>Summary Dimensions</h3>
    <p>
      Outcome: <strong><%= @trace.summary.outcome || "n/a" %></strong> |
      Entity: <strong><%= @trace.summary.entity_type || "n/a" %>#<%= @trace.summary.entity_id || "n/a" %></strong> |
      HTTP: <strong><%= @trace.summary.request_method || "n/a" %> <%= @trace.summary.http_status || "n/a" %></strong> |
      SQL: <strong><%= @trace.summary.sql_count %> queries / <%= @trace.summary.sql_duration_ms %> ms</strong>
    </p>
    <p class="muted">
      Path: <%= @trace.summary.path || "n/a" %> |
      Request ID: <%= @trace.summary.request_id || "n/a" %> |
      Service: <%= @trace.summary.service_name || "n/a" %> |
      Env: <%= @trace.summary.environment_name || "n/a" %> |
      Version: <%= @trace.summary.service_version || "n/a" %> |
      Deploy: <%= @trace.summary.deployment_id || "n/a" %> |
      Region: <%= @trace.summary.region || "n/a" %> |
      Job: <%= @trace.summary.job_class || "n/a" %> |
      Queue: <%= @trace.summary.queue_name || "n/a" %>
    </p>
  </div>
<% end %>

<div class="card">
  <h3>Correlation Pivots (7d)</h3>
  <p>
    Same Entity Traces: <strong><%= @correlation[:entity_trace_count] %></strong> |
    Same Entity Errors: <strong><%= @correlation[:entity_error_count] %></strong> |
    Same Fingerprint Traces: <strong><%= @correlation[:fingerprint_trace_count] %></strong> |
    Same Fingerprint Errors: <strong><%= @correlation[:fingerprint_error_count] %></strong>
  </p>
  <p>
    <% if @trace.summary&.entity_type.present? && @trace.summary&.entity_id.present? %>
      <%= link_to "Open all traces for this entity", traces_path(entity_type: @trace.summary.entity_type, entity_id: @trace.summary.entity_id), class: "button button-muted" %>
      <%= link_to "Journey API (entity)", "/solid_events/api/journeys?entity_type=#{CGI.escape(@trace.summary.entity_type)}&entity_id=#{@trace.summary.entity_id}&window=24h", class: "button button-muted" %>
    <% end %>
    <% if @trace.summary&.error_fingerprint.present? %>
      <%= link_to "Open all traces for this error fingerprint", traces_path(error_fingerprint: @trace.summary.error_fingerprint), class: "button button-muted" %>
    <% end %>
    <% if @trace.summary&.request_id.present? %>
      <%= link_to "Open all traces for this request id", traces_path(request_id: @trace.summary.request_id), class: "button button-muted" %>
      <%= link_to "Journey API (request)", "/solid_events/api/journeys?request_id=#{CGI.escape(@trace.summary.request_id)}&window=24h", class: "button button-muted" %>
    <% end %>
  </p>
  <p class="muted">
    Duration Trend (24h vs prior 7d): <%= @correlation[:recent_avg_duration_ms] || "n/a" %> ms vs <%= @correlation[:baseline_avg_duration_ms] || "n/a" %> ms
    (<%= duration_delta_label(@correlation[:recent_avg_duration_ms], @correlation[:baseline_avg_duration_ms]) %>)
    <% if @correlation[:duration_regression] %>
      <span class="badge error">regression</span>
    <% else %>
      <span class="badge ok">stable</span>
    <% end %>
  </p>
</div>

<div class="card">
  <h3>Related Traces by Entity</h3>
  <div class="table-scroll">
    <table class="events-table">
      <thead>
        <tr>
          <th>Trace</th>
          <th>Name</th>
          <th>Status</th>
          <th>Source</th>
          <th>Started</th>
        </tr>
      </thead>
      <tbody>
        <% @related_entity_traces.each do |trace| %>
          <tr>
            <td><%= link_to trace.id, trace_path(trace) %></td>
            <td><%= trace.name %></td>
            <td><span class="badge <%= trace_status_badge(trace.status) %>"><%= trace.status %></span></td>
            <td><%= trace.source %></td>
            <td title="<%= absolute_time(trace.started_at) %>"><%= relative_time(trace.started_at) %></td>
          </tr>
        <% end %>
        <% if @related_entity_traces.empty? %>
          <tr><td colspan="5" class="muted">No related entity traces.</td></tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<div class="card">
  <h3>Related Traces by Error Fingerprint</h3>
  <div class="table-scroll">
    <table class="events-table">
      <thead>
        <tr>
          <th>Trace</th>
          <th>Name</th>
          <th>Status</th>
          <th>Source</th>
          <th>Started</th>
        </tr>
      </thead>
      <tbody>
        <% @related_fingerprint_traces.each do |trace| %>
          <tr>
            <td><%= link_to trace.id, trace_path(trace) %></td>
            <td><%= trace.name %></td>
            <td><span class="badge <%= trace_status_badge(trace.status) %>"><%= trace.status %></span></td>
            <td><%= trace.source %></td>
            <td title="<%= absolute_time(trace.started_at) %>"><%= relative_time(trace.started_at) %></td>
          </tr>
        <% end %>
        <% if @related_fingerprint_traces.empty? %>
          <tr><td colspan="5" class="muted">No related fingerprint traces.</td></tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<div class="card">
  <h3>Context</h3>
  <% if @trace.context.present? %>
    <pre><%= JSON.pretty_generate(@trace.context) %></pre>
  <% else %>
    <p class="muted">No context captured.</p>
  <% end %>
</div>

<div class="card">
  <h3>Trace Waterfall</h3>
  <div class="table-scroll">
    <table class="events-table">
      <thead>
        <tr>
          <th>At</th>
          <th>Type</th>
          <th>Name</th>
          <th>Duration</th>
          <th>Payload</th>
        </tr>
      </thead>
      <tbody>
        <% @events.each do |event| %>
          <tr>
            <td title="<%= absolute_time(event.occurred_at) %>"><%= relative_time(event.occurred_at) %></td>
            <td><span class="badge muted"><%= event.event_type %></span></td>
            <td><code><%= event.name %></code></td>
            <td><%= event.duration_ms ? "#{event.duration_ms} ms" : "n/a" %></td>
            <td>
              <details>
                <summary><%= event_payload_summary(event) %></summary>
                <pre><%= JSON.pretty_generate(event.payload || {}) %></pre>
              </details>
            </td>
          </tr>
        <% end %>
        <% if @events.empty? %>
          <tr>
            <td colspan="5" class="muted">No events captured for this trace.</td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<div class="card">
  <h3>Record Links</h3>
  <ul>
    <% @record_links.each do |link| %>
      <li><code><%= link.record_type %>#<%= link.record_id %></code></li>
    <% end %>
    <% if @record_links.empty? %>
      <li class="muted">No records linked.</li>
    <% end %>
  </ul>
</div>

<div class="card">
  <h3>Error Links</h3>
  <ul>
    <% @error_links.each do |link| %>
      <li><%= link_to "SolidError ##{link.solid_error_id}", "/solid_errors/#{link.solid_error_id}" %></li>
    <% end %>
    <% if @error_links.empty? %>
      <li class="muted">No errors linked.</li>
    <% end %>
  </ul>
</div>
